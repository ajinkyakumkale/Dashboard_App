package com.example.demo.controller;

import com.example.demo.model.*;

import java.util.Iterator;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PatchMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.example.demo.repository.UserDAO;
import com.example.demo.repository.loginDAO;

import jakarta.persistence.metamodel.SetAttribute;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;

@Controller
public class DemoController {
	@Autowired
	private loginDAO loginD;
	@Autowired
	private UserDAO userD;

	@RequestMapping(path = "/register", method = RequestMethod.POST)
	public String Register(HttpServletRequest request) {
		String s1 = request.getParameter("t1");
		String s2 = request.getParameter("t2");
		String s3 = request.getParameter("t3");
		Login login = new Login(s1, s2, s3);
		loginD.save(login);
		System.out.println(login);

		return "Index.jsp";
	}

	@RequestMapping("/")
	public String Login() {

		return "Signin.jsp";
	}

	@GetMapping("/all")
	public List<Login> getLogin() {
		return loginD.findAll();

	}

	@RequestMapping(path = "/verify", method = RequestMethod.POST)
	public String welcome(@RequestParam("t1") String username, @RequestParam("t2") String password) {
		// String s1 = request.getParameter("t1");
		// String s2 = request.getParameter("t2");
		String s1 = username;
		String s2 = password;
		List l1 = loginD.findAll();

		Iterator itr = l1.iterator();
		while (itr.hasNext()) {

			Login lg = (com.example.demo.model.Login) itr.next();
			String u = lg.getUsername();
			String p = lg.getPassword();
			if (s1.equals(u) && s2.equals(p)) {
				return "dashboard.jsp";
			}
		}
		return "Index.jsp";
	}

	@RequestMapping(path = "/adduser", method = RequestMethod.POST)
	public String adduser(@RequestParam("t1") int id, @RequestParam("t2") String firstname,
			@RequestParam("t3") String lastname, @RequestParam("t4") String username,
			@RequestParam("t5") String contact, @RequestParam("t6") String email, @RequestParam("t7") String password,
			HttpSession session) {
		User user = new User(id, firstname, lastname, username, contact, email, password);
		System.out.println(user);
		session.setAttribute("name", user);
		// try {
//			User u = userD.save(user);
//		} catch (Exception e) {
//			return "User not added";
//		}

		return "redirect:/adduserreturn.jsp";
	}

	@RequestMapping(path = "/searchbyid", method = RequestMethod.POST)
	public String search(HttpServletRequest request, HttpSession session) {
		int i = Integer.parseInt(request.getParameter("t1"));
		User user = userD.findById(i).get();
		String s = user.toString();
		session.setAttribute("name", s);
		return "findbyid.jsp";
	}

	@RequestMapping(path = "/edituser", method = RequestMethod.POST)
	public String edituser(@RequestParam("t1") int id, @RequestParam("t2") String firstname,
			@RequestParam("t3") String lastname, @RequestParam("t4") String username,
			@RequestParam("t5") String contact, @RequestParam("t6") String email, @RequestParam("t7") String password,
			HttpSession session) {
		User user = new User(id, firstname, lastname, username, contact, email, password);
		List l = userD.findAll();
		Iterator itr = l.iterator();
		String s1 = "User is Added";
		String s2 = "User is not available";
		while (itr.hasNext()) {
			User u = (User) itr.next();
			if (u.getId() == id) {
				userD.save(user);
				session.setAttribute("name", s1);
				return "edituser.jsp";
			} else {
				session.setAttribute("name", s2);
				return "edituser.jsp";
			}
		}
		session.setAttribute("name", s2);
		return "edituser.jsp";

	}

	@RequestMapping(path = "/delete", method = RequestMethod.POST)
	public String delete(HttpServletRequest request, HttpSession session) {
		int id = Integer.parseInt(request.getParameter("t1"));
		List l = userD.findAll();

		Iterator itr = l.iterator();
		String s1 = "User is deleted";
		String s2 = "User is not available";
		while (itr.hasNext()) {
			User u = (User) itr.next();
			System.out.println(u);
			if (u.getId() == id) {
				userD.deleteById(id);
				session.setAttribute("name", s1);
				return "deletebyid.jsp";
			}
		}

		session.setAttribute("name", s2);
		return "deletebyid.jsp";
	}
}